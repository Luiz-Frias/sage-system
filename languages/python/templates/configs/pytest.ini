# Pytest Configuration for Insurance API Testing
# Comprehensive testing setup with async support and coverage

[tool:pytest]
# Test discovery
python_files = test_*.py *_test.py
python_classes = Test* *Tests
python_functions = test_*
testpaths = tests

# Minimum Python version
minversion = 6.0

# Strict markers
addopts = 
    --strict-markers
    --strict-config
    --verbose
    -ra
    --cov=app
    --cov-branch
    --cov-report=term-missing:skip-covered
    --cov-report=html:htmlcov
    --cov-report=xml:coverage.xml
    --cov-fail-under=80
    --maxfail=1
    --tb=short
    --asyncio-mode=auto
    --disable-warnings
    -p no:warnings

# Async configuration
asyncio_mode = auto

# Markers for test organization
markers =
    unit: Unit tests that test individual components in isolation
    integration: Integration tests that test component interactions
    e2e: End-to-end tests that test complete user flows
    slow: Tests that take more than 1 second to run
    external: Tests that require external services
    smoke: Critical path tests for deployment validation
    regression: Tests for previously fixed bugs
    security: Security-focused tests
    performance: Performance and load tests
    policy: Policy engine specific tests
    pricing: Pricing engine specific tests
    underwriting: Underwriting service tests
    claims: Claims processing tests
    api: API endpoint tests
    database: Database interaction tests
    redis: Redis/caching tests
    mock_external: Tests that mock external services

# Test output
console_output_style = progress
junit_suite_name = Insurance API Test Suite
junit_logging = all
junit_log_passing_tests = true

# Coverage configuration
[coverage:run]
source = app
omit = 
    */tests/*
    */migrations/*
    */__pycache__/*
    */venv/*
    */.venv/*
    */env/*
    */.env/*
    */alembic/*
    */scripts/*
    */conftest.py
    */__init__.py

parallel = true
concurrency = multiprocessing
context = ${COV_CORE_CONTEXT}

[coverage:report]
precision = 2
show_missing = true
skip_covered = false
sort = Cover
exclude_lines =
    # Standard pragma
    pragma: no cover
    
    # Debug-only code
    def __repr__
    if self\.debug
    
    # Defensive programming
    raise AssertionError
    raise NotImplementedError
    
    # Non-runnable code
    if 0:
    if False:
    if __name__ == .__main__.:
    
    # Abstract methods
    @(abc\.)?abstractmethod
    
    # Type checking
    if TYPE_CHECKING:
    @overload
    
    # Protocols
    class .*Protocol\):
    @runtime_checkable

[coverage:html]
directory = htmlcov
title = Insurance API Coverage Report
show_contexts = true

[coverage:xml]
output = coverage.xml

# Logging configuration for tests
[pytest.logging]
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] [%(name)s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = tests.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] [%(name)s] %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# Timeout configuration
[pytest.timeout]
timeout = 300
timeout_method = thread

# Fixtures
[pytest.fixtures]
# Fixture configuration
fixture_path = tests/fixtures

# Environment variables for testing
[pytest.env]
ENVIRONMENT = test
DATABASE_URL = postgresql://test:test@localhost:5432/test_insurance_db
REDIS_URL = redis://localhost:6379/1
API_KEY_HEADER = X-API-Key
JWT_SECRET_KEY = test-secret-key
ENABLE_METRICS = false
LOG_LEVEL = DEBUG
# SAGE Wave Orchestrator Specification
# Supervisor runtime contract for dynamic phase/wave planning and execution.

version: "1.1.0"
specification_name: "Wave Orchestrator"
specification_type: "core_engine"

contract_dependency:
  planning_output_contract: "core/engine/planning-output-contract.yaml"

planning_mode:
  strategy: "dynamic_phase_wave_generation"
  objective: "Generate implementation plans that satisfy output contract cardinality and gate policy."
  migration_note: "Contract applies to generated plans, not to the migration workflow that updates this repository."

planning_output_contract:
  apply_contract_to_generated_plans_only: true

  phase_count:
    minimum: 7
    recommended_range: [7, 12]
    unbounded: true
    expansion_trigger:
      - "roadmap_backlog_remaining"
      - "high_risk_or_high_dependency_surface"

  waves_per_phase:
    minimum: 5
    recommended_range: [5, 10]
    unbounded: true
    expansion_trigger:
      - "parallelizable_scope_width"
      - "cross_domain_dependency_volume"

  milestones_per_phase:
    exact: 4
    sequence: "strict"

  tasks_per_milestone:
    exact: 15
    sequence: "strict"

plan_generation_algorithm:
  phase_planning:
    - "Ingest roadmap and dependency graph."
    - "Emit initial phases in [7,12] range."
    - "Append phases until backlog coverage == 100%."

  wave_planning:
    - "Decompose each phase into independent concern clusters."
    - "Emit at least 5 waves per phase."
    - "Expand wave count until critical-path depth and lane conflicts are acceptable."

  milestone_planning:
    - "Emit exactly 4 milestones per phase."
    - "Enforce strict sequencing M1 -> M2 -> M3 -> M4."

  task_planning:
    - "Emit exactly 15 tasks per milestone."
    - "Enforce strict sequencing T01 -> T15."
    - "Attach dependencies and done criteria per task."

fan_out_fan_in_model:
  fan_out:
    description: "Execute parallel lanes by separation of concerns within each wave."
    required_lanes:
      - "contract_updates"
      - "logic_updates"
      - "validation_and_tests"
      - "integration_and_references"

  fan_in:
    description: "Merge lanes to wave gate, then wave gates to milestone gate, then milestone gates to phase gate."
    merge_preconditions:
      - "lane_unit_gate_passed"
      - "lane_integration_gate_passed"
      - "dependency_conflicts_resolved"

parallelization_rules:
  core_principles:
    - "Maximize independent work streams per wave."
    - "Preserve strict milestone and task ordering."
    - "Block fan-in on unresolved contract violations."
    - "Allow wave cardinality growth when needed."

  dependency_categories:
    hard_dependencies:
      description: "Dependent work cannot start before prerequisite completion."
      handling: "block_until_resolved"

    soft_dependencies:
      description: "Dependent work can start with temporary placeholders."
      handling: "proceed_with_contract_placeholders"

    runtime_dependencies:
      description: "Dependency discovered during execution."
      handling: "resolve_via_message_queue_and_replan"

  conflict_prevention:
    branch_isolation:
      description: "Each lane uses isolated branch namespace."
      naming_pattern: "codex/p{PHASE}/w{WAVE}/lane-{CONCERN}"
      merge_strategy: "lane_to_wave_fanin_to_milestone_fanin_to_phase_fanin"

    file_locking:
      description: "Prevent concurrent file edits across lanes."
      lock_granularity: "file"
      lock_duration: "until_lane_fanin_or_timeout"
      timeout: "2_hours"

gate_policy:
  milestone_gate:
    unit_gate:
      required: true
      criteria:
        - "schema_and_contract_checks_pass"
        - "deterministic_behavior_checks_pass"

    integration_gate:
      required: true
      start_after_repo_init: true
      criteria:
        - "cross_lane_contract_compatibility_pass"
        - "dependency_resolution_pass"

  phase_gate:
    phase_end_e2e:
      required: true
      criteria:
        - "all_milestones_completed"
        - "phase_level_end_to_end_pass"

  rolling_gate:
    starts_after_phase: 1
    inter_phase_integration_required: true
    cumulative_e2e_required: true
    criteria:
      - "phase_N_integrates_with_completed_phases"
      - "cumulative_end_to_end_pass"

orchestration_phases:
  pre_wave:
    description: "Gather context, build dependency DAG, assign lanes, and pre-compute gate criteria."
    outputs:
      - "phase_plan"
      - "wave_plan"
      - "lane_assignments"
      - "gate_matrix"

  wave_execution:
    description: "Execute fan-out lanes with continuous dependency and gate monitoring."
    monitoring:
      - "progress_tracking"
      - "dependency_satisfaction"
      - "contract_conformance"
      - "quality_gate_status"

  post_wave:
    description: "Execute wave fan-in, update artifacts, and prepare next wave."
    outputs:
      - "wave_completion_report"
      - "updated_dependency_graph"
      - "milestone_gate_snapshot"

performance_metrics:
  plan_conformance:
    - "phase_count_compliance"
    - "wave_count_compliance"
    - "milestone_count_compliance"
    - "task_count_compliance"

  execution_efficiency:
    - "lane_parallelization_factor"
    - "fan_in_delay"
    - "dependency_resolution_time"
    - "rework_rate"

  quality:
    - "milestone_gate_pass_rate"
    - "phase_e2e_pass_rate"
    - "rolling_integration_pass_rate"

adaptation_mechanisms:
  phase_expansion:
    description: "Add phases when roadmap scope remains after planned phase completion."
    approval_required: false

  wave_expansion:
    description: "Add waves when lane collision or critical-path overload is detected."
    approval_required: false

  scope_reallocation:
    description: "Move tasks between waves while preserving milestone sequence and task cardinality."
    process:
      - "detect_overload"
      - "propose_reallocation"
      - "validate_contract"
      - "apply_and_broadcast"
